<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
        <style>

        html, body, #map {
          width: 600px;
          height: 580px;
          margin: 0;
          padding: 0;
        }
        #trend{
          width: 600px;
          height: 580px;
          align-content: center;
        }
        body{
            background: #eee;
        }
        .axis path, .axis line{
            fill: none;
            stroke: black;
            shape-rendering: auto;
        }
        .axis text{
            font-size: 12px;
        }
        .stations, .stations svg {
          position: absolute;
        }
        .stations circle {
          stroke: gray;
          stroke-width: 1.5px;
        }

        </style>
        <!-- Google Map API ----->
        <script src="//maps.google.com/maps/api/js?key=AIzaSyCPJTYlcca1Kc9bYBre-KwXO6MOJuOtHqw&sensor=true"></script>
        <script src="//d3js.org/d3.v3.min.js"></script>
        
    </head>
    <body>
        <table>
           <tr><td colspan="2" align="center"><h3>2016年實價登錄行情地圖</h1></td></tr>
           <tr>
               <td><div id="map"></div></td>
               <td>
                   <div id="trend">
                       <p id="title" align="center" style="background-color: #6495ED; color: white; font-size: 18px;font-weight:bold;border-style: solid">歷年趨勢圖</p>
                       <svg id="chart" width="600px" height="580px">
                           <path id="trendPath"></path>
                           <g id="axisX"></g>
                           <g id="axisY"></g>
                       </svg>
                   </div>
               </td>
           </tr>
        </table>
       <script>
            var cityZoom = 12;
            var areaZoom = 16;
            var priceUnit = 50000;
            var level = "City";
            
           var w = 600;
            var h = 580;
            var p = 50;
           
            // 產生 Google Map…
            var map = new google.maps.Map(d3.select("#map").node(), {
              zoom: 8,
              center: new google.maps.LatLng(23.78330933101,120.90602480468749),
              mapTypeId: google.maps.MapTypeId.TERRAIN
            });
            var overlay = new google.maps.OverlayView();
            map.addListener('center_changed', function(){
//                var centerPos = map.getCenter();
//                console.log(centerPos);
                if (map.getZoom() >= areaZoom){
                    overlay.draw();
                }
            });

            // 讀取外部資料
            d3.csv("Data.csv", row, function(dataSet) {
                //console.log(dataSet);
                var newDataSet = dataSet.filter(function(d){
                    return (d.Type.indexOf("公寓") > -1 || d.Type.indexOf("住宅大樓") > -1 || d.Type.indexOf("套房") > -1 || d.Type.indexOf("透天厝") > -1 || d.Type.indexOf("華廈") > -1);
                });
                //console.log(newDataSet);
                UpdateMap(newDataSet);
            });
            
            function row(d){
                d.Price = +d.Price;
                d.lat = +d.lat;
                d.lng = +d.lng;
                d.Year = +d.Year;
                d.TransDate = new Date(d.TransDate);
                
                return d;
            }
            
            function UpdateMap(dataSet){
                overlay.onAdd = function() {
                    var layer = d3.select(this.getPanes().overlayMouseTarget)
                                  .append("div")
                                  .attr("class", "stations");
                    overlay.draw = function(){
                        var zoom = map.getZoom();
                        UpdateLevel(zoom);
                        //console.log("map.getZoom(): " + zoom);
                        var bounds = map.getBounds().toJSON();
                        var nestDataSet = NestDataSet(dataSet, zoom);
                        // 細到地址時，避免資料太多影響效能，使用地圖的Bounds將資料過濾
                        if (level == "Address")
                        {
                            nestDataSet = nestDataSet.filter(function(d){
                                              return (d.values.lat >= bounds.south &&
                                                     d.values.lat <= bounds.north &&
                                                     d.values.lng >= bounds.west &&
                                                     d.values.lng <= bounds.east);
                                          });
                        }
                        nestDataSet = nestDataSet.sort(function(a, b){
                                                return d3.descending(a.values.Price, b.values.Price);
                                            });
                        var minPrice = d3.min(nestDataSet, function(d){
                                            //console.log(d.values.Price);
                                            return GetPriceRange(d.values.Price);
                                        });
                        //console.log(minPrice);
                        var maxPrice = d3.max(nestDataSet, function(d){
                                            //console.log(d.values.Price);
                                            return GetPriceRange(d.values.Price);
                                        });
                        //console.log(maxPrice);
                        
                        var rScale = d3.scale.linear()
                                        .domain([minPrice, maxPrice])
                                        .range([15,40]);
                        //console.log(rScale(250000));
                        var fScale = d3.scale.category20();
                        
                        var projection = this.getProjection(),
                          padding = 10;
                        
                        layer.selectAll("svg").remove();
                        var marker = layer.selectAll("svg")
                                          .data(nestDataSet)
                                          .each(transform)
                                          .enter().append("svg")
                                          .each(transform);
                       //增加圓點
                      marker.append("circle")
                          .attr("r", function(d){ return rScale(GetPriceRange(d.values.Price)); })
                          .attr("cx", function(d){ return rScale(GetPriceRange(d.values.Price)) + padding; })
                          .attr("cy", function(d){ return rScale(GetPriceRange(d.values.Price)) + padding; })
                          .attr("fill", function(d){ return fScale(d.key); })
                          .on("mouseover",function(d){
                              //console.log("mouseover");
                              d3.select(this.parentNode).select("text").attr({
                                 opacity: 1
                              });
                          })
                          .on("mouseout",function(d){
                               //console.log("mouseout");
                               d3.select(this.parentNode).select("text").attr({
                                 opacity: 0
                              });
                          })
                          .on("click",function(d){
                               DrawTrendChart(d.key);
                          });
                      
                     // 增加文字說明
                     marker.append("text")
                          .attr({
                              x: function(d){ return rScale(GetPriceRange(d.values.Price));},
                              y: function(d){ return rScale(GetPriceRange(d.values.Price)) + padding;},
                              "font-size": "18px",
                              fill: "blue",
                              opacity: 0
                          })     
                          .text(function(d) { 
                                //console.log(d);
                                return d.key + ": " + Math.round(d.values.Price / 10000) + "萬"; 
                          });
                      
                      function transform(d) {
                          //console.log(d);
                        var w = rScale(GetPriceRange(d.values.Price));
                        //console.log(w);
                        d = new google.maps.LatLng(+d.values.lat,+d.values.lng);

                        d = projection.fromLatLngToDivPixel(d);
                        
                        //console.log(d);
                        return d3.select(this)
                            .style("left", (d.x - w - padding) + "px")
                            .style("top", (d.y - w - padding) + "px")
                            .style("width", ((w + padding)*2 + 300) + "px")
                            .style("height", ((w + padding)*2) + "px");
                      }  
                    };
                };
//                overlay.onRemove = function(){
//                    console.log("overlay.onRemove event!");
//                }
                
                overlay.setMap(map);
            }
            function UpdateLevel(zoom){
                if (zoom < cityZoom)
                    level = "City";
                else if (zoom < areaZoom)
                    level = "Area";
                else
                    level = "Address";
            }
            function NestDataSet(dataSet){
                var nestDataSet;
                
                nestDataSet = d3.nest()
                                .key(function(d){
                                    return d[level];
                                })
                                .rollup(function(d){
                                    return{
                                        lat: d3.mean(d, function(v){ return v.lat}),
                                        lng: d3.mean(d, function(v){ return v.lng}),
                                        Price: d3.mean(d, function(v){ return v.Price;})
                                    }
                                })
                                .entries(dataSet);
                //console.log(nestDataSet);
                return nestDataSet;
            }
            function GetPriceRange(price)
            {
                return Math.floor(price / priceUnit) * priceUnit;
            }
            function DrawTrendChart(filterValue){
                d3.csv("HistoryData.csv", function(dataSet) {
                    var filteredDataSet = dataSet.filter(function(d){
                        return (d[level] == filterValue) && (+d.Year >= 2000);
                    });
                    
                    var newDataSet = d3.nest()
                                   .key(function(d){
                                        return d.Year;
                                    })
                                   .rollup(function(d){
                                        return {
                                            Price: d3.mean(d, function(v){ return +v.Price; })
                                        }
                                    })
                                    .entries(filteredDataSet)
                                    .sort(function(a, b){
                                                return d3.ascending(a.key, b.key);
                                            });
                    //console.log(newDataSet);
                    var minDate = d3.min(newDataSet, function(d){
                                            return new Date(d.key);
                                        });
                    var maxDate = d3.max(newDataSet, function(d){
                                            return new Date(d.key);
                                        });
                    var xScale = d3.time.scale()
                                    .domain([minDate, maxDate])
                                    .range([p,w-p]);
                    
                    var minPrice = d3.min(newDataSet, function(d){
                                            return d.values.Price;
                                        });
                    var maxPrice = d3.max(newDataSet, function(d){
                                            return d.values.Price;
                                        });
                    var yScale = d3.scale.linear()
                                    .domain([minPrice,maxPrice])
                                    .range([h-p,p]);
                    
                    
                    var line = d3.svg.line()
                                .x(function(d){
//                                    console.log("x-value: " + d.key);
//                                    console.log("x: " + xScale(new Date(d.key)));
                                    return xScale(new Date(d.key));
                                })
                                .y(function(d){
//                                    console.log("y-value: " + d.values.Price);
//                                    console.log("y: " + yScale(d.values.Price));
                                    return yScale(d.values.Price);
                                });
                    //console.log(newDataSet);
                    d3.select("#chart").select("#trendPath")
                                      .attr({
                                         d: line(newDataSet),
                                         stroke: "#8B2252",
                                         "stroke-width" : 3,
                                          fill: "none"
                                          //transform: "translate(10,0)"
                                      });
                    
//                    var selection = d3.select("#chart").selectAll("text").data(newDataSet);
//                    selection.enter().append("text");
//                    selection.exit().remove();
//                    d3.select("#chart").selectAll("text").attr({
//                            x: function(d){ return xScale(new Date(d.key)) + 10;},
//                            y: function(d){ return yScale(d.values.Price) + 10;},
//                            "font-size": "15px"
//                        })
//                        .text(function(d) { 
//                                return Math.round(d.values.Price / 10000) + "萬"; 
//                          });
                    
                    var xAxis = d3.svg.axis().scale(xScale).orient("bottom");
                    var yAxis = d3.svg.axis().scale(yScale).orient("left");
                    d3.select("#chart")
                        .select("g#axisY")
                        .attr("class","axis")
                        .attr("transform", "translate("+(p)+",0)")
                        .call(yAxis);
                    d3.select("#chart")
                        .select("g#axisX")
                        .attr("class","axis")
                        .attr("transform", "translate(0,"+(h-p+10)+")")
                        .call(xAxis);
                    d3.select("#title").text(filterValue + " 歷年趨勢圖");
                });
            }
            
       </script>
    </body>
</html>

